---
phase: 03-habit-tracker
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - ios/HabitTracker/Services/StreakCalculator.swift
  - ios/HabitTracker/Views/Components/StreakBadge.swift
  - ios/HabitTracker/Views/HabitDetailView.swift
  - ios/HabitTracker/Views/Components/HabitRow.swift
  - ios/HabitTracker/Views/HabitListView.swift
autonomous: true

must_haves:
  truths:
    - "User sees current streak count on each habit row"
    - "User sees longest streak on habit detail page"
    - "Streak resets to 0 if user misses a day"
    - "User sees weekly bar chart of completions on habit detail page"
    - "User sees monthly completion grid/chart on habit detail page"
  artifacts:
    - path: "ios/HabitTracker/Services/StreakCalculator.swift"
      provides: "Streak calculation from completion records"
      contains: "calculateStreak"
    - path: "ios/HabitTracker/Views/Components/StreakBadge.swift"
      provides: "Streak counter UI component"
      contains: "flame.fill"
    - path: "ios/HabitTracker/Views/HabitDetailView.swift"
      provides: "Detail view with charts and streak display"
      contains: "import Charts"
  key_links:
    - from: "ios/HabitTracker/Services/StreakCalculator.swift"
      to: "ios/HabitTracker/Models/HabitCompletion.swift"
      via: "Processes completion array to compute streaks"
      pattern: "HabitCompletion"
    - from: "ios/HabitTracker/Views/HabitDetailView.swift"
      to: "ios/HabitTracker/Services/StreakCalculator.swift"
      via: "Calls calculateStreak for display"
      pattern: "StreakCalculator"
    - from: "ios/HabitTracker/Views/HabitDetailView.swift"
      to: "Charts framework"
      via: "BarMark for weekly progress"
      pattern: "BarMark"
---

<objective>
Add streak calculation, streak badge UI, and habit detail view with Swift Charts progress visualization to the iOS Habit Tracker.

Purpose: Implements streak counter (HABT-03) and progress chart (HABT-04) — the data visualization features that showcase SwiftUI Charts skills to potential clients.
Output: HabitDetailView with current/longest streak display and weekly/monthly progress charts.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-habit-tracker/03-RESEARCH.md
@.planning/phases/03-habit-tracker/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement StreakCalculator service and StreakBadge component</name>
  <files>
    ios/HabitTracker/Services/StreakCalculator.swift
    ios/HabitTracker/Views/Components/StreakBadge.swift
  </files>
  <action>
    **Services/StreakCalculator.swift:**
    - Import Foundation
    - struct StreakCalculator with static methods (no state, pure functions)
    - Method `calculateStreak(from completions: [HabitCompletion]) -> (current: Int, longest: Int)`:
      1. Filter completions to only .done status
      2. Map dates to start-of-day using Calendar.current.startOfDay(for:) to normalize timezone issues
      3. Remove duplicate dates (Set), sort descending (most recent first)
      4. Walk sorted dates: if consecutive day difference == 1, increment temp streak; else save longest and reset
      5. Current streak: only valid if most recent completion is today or yesterday (daysSinceRecent <= 1)
      6. Return (current, longest)
    - Method `weeklyCompletions(from completions: [HabitCompletion], weeksBack: Int = 1) -> [(date: Date, count: Int)]`:
      1. Calculate start date: Calendar subtract weeksBack*7 days from today
      2. Filter completions to .done status within date range
      3. Group by day, return array of (date, count) for each day in range (fill 0 for missing days)
    - Method `monthlyCompletionRate(from completions: [HabitCompletion], monthsBack: Int = 1) -> [(date: Date, completed: Bool)]`:
      1. For each day in the past month, check if a .done completion exists
      2. Return array of (date, completed) pairs

    **CRITICAL:** Always use Calendar.current.startOfDay(for:) when comparing dates. Never compare Date objects directly — timezone issues will break streaks.

    **Views/Components/StreakBadge.swift:**
    - Import SwiftUI
    - Takes streak: Int and optional label: String (default "Current")
    - Layout: HStack with flame.fill icon (orange) + streak count text
    - Capsule background with orange.opacity(0.15) fill
    - If streak == 0, show dimmed style (gray instead of orange)
    - If streak >= 7, show enhanced style (larger flame, gold tint)
    - Font: .headline for count, .caption2 for label
  </action>
  <verify>
    - ls ios/HabitTracker/Services/StreakCalculator.swift
    - ls ios/HabitTracker/Views/Components/StreakBadge.swift
    - grep "startOfDay" ios/HabitTracker/Services/StreakCalculator.swift (must exist for date normalization)
    - grep "calculateStreak" ios/HabitTracker/Services/StreakCalculator.swift
  </verify>
  <done>
    StreakCalculator computes current and longest streaks using Calendar-normalized dates with proper timezone handling. StreakBadge displays streak count with flame icon and visual states for zero/active/milestone streaks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build HabitDetailView with Swift Charts, streak display, and wire NavigationLink</name>
  <files>
    ios/HabitTracker/Views/HabitDetailView.swift
    ios/HabitTracker/Views/Components/HabitRow.swift
    ios/HabitTracker/Views/HabitListView.swift
  </files>
  <action>
    **Views/HabitDetailView.swift:**
    - Import SwiftUI, SwiftData, and Charts
    - Takes habit: Habit as parameter
    - @Environment(\.modelContext) private var modelContext
    - @State private var selectedChartPeriod: ChartPeriod = .week (enum: week, month)
    - Layout (ScrollView):
      1. **Header section:** Habit icon (large, in habit.color) + habit name + edit button (navigates to AddHabitView with habitToEdit)
      2. **Streak section:** HStack with two StreakBadge components:
         - Current streak (label: "Current") using StreakCalculator.calculateStreak(from: habit.completions).current
         - Longest streak (label: "Best") using .longest
      3. **Today's status:** Large toggle button — "Mark as Done" or "Completed" with checkmark animation
         - Calls habit.toggleToday(context: modelContext)
      4. **Chart section:**
         - Picker for week/month toggle (segmented style)
         - Weekly view: BarMark chart showing completions per day for last 7 days
           - X axis: day of week labels (Mon, Tue, etc.)
           - Y axis: completion count (0 or 1 for single habit)
           - Bar color: habit's accent color
           - Use StreakCalculator.weeklyCompletions() for data
         - Monthly view: BarMark chart showing completions per day for last 30 days
           - X axis: date labels (day number)
           - Y axis: completed (0/1)
           - Use StreakCalculator.monthlyCompletionRate() for data
           - Alternatively: Grid of 30 small squares (filled = completed, empty = missed) like GitHub contribution graph
      5. **Stats section:** VStack with:
         - Total completions count
         - Completion rate (percentage of days since creation)
         - Date created

    **Chart styling:**
    - Use .chartPlotStyle { plotArea in plotArea.frame(height: 200) }
    - Chart background: clear (dark theme handles it)
    - Grid lines: subtle gray
    - Bar corner radius: 4

    **HabitRow.swift update (minor):**
    - Add StreakBadge(streak: currentStreak) to the right side of each row, before the checkoff button
    - Compute streak using StreakCalculator.calculateStreak(from: habit.completions).current
    - Only show badge if streak > 0

    **HabitListView.swift wiring (minor):**
    - In HabitListView, wrap each HabitRow(habit:) inside a NavigationLink(destination: HabitDetailView(habit: habit)) so tapping a row navigates to the detail view
    - This wiring was deferred from Plan 01 because HabitDetailView did not exist yet

    **Data structure for charts:**
    ```swift
    struct DailyCompletion: Identifiable {
        let id = UUID()
        let date: Date
        let completed: Bool
    }
    ```
    Define this within HabitDetailView or as a private struct in the file.
  </action>
  <verify>
    - ls ios/HabitTracker/Views/HabitDetailView.swift
    - grep "import Charts" ios/HabitTracker/Views/HabitDetailView.swift
    - grep "BarMark" ios/HabitTracker/Views/HabitDetailView.swift
    - grep "StreakBadge" ios/HabitTracker/Views/Components/HabitRow.swift (updated with streak)
  </verify>
  <done>
    HabitDetailView displays current/longest streak badges, today's completion toggle, and weekly/monthly progress charts using Swift Charts BarMark. HabitRow shows inline streak badge for habits with active streaks.
  </done>
</task>

</tasks>

<verification>
1. All 3 new files exist (StreakCalculator, StreakBadge, HabitDetailView)
2. HabitRow.swift updated with StreakBadge integration
3. StreakCalculator uses Calendar.current.startOfDay(for:) for date normalization
4. HabitDetailView imports Charts framework and uses BarMark
5. Weekly and monthly chart data derived from StreakCalculator methods
6. Streak resets properly when most recent completion is older than yesterday
</verification>

<success_criteria>
iOS Habit Tracker detail view shows streak badges (current + longest), today's toggle, and interactive weekly/monthly progress charts using Swift Charts. Streak calculation handles timezone normalization and proper reset logic.
</success_criteria>

<output>
After completion, create `.planning/phases/03-habit-tracker/03-02-SUMMARY.md`
</output>
